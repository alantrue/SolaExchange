<!DOCTYPE html>
<html>

<head>
    <title>Demo</title>
    <link rel="stylesheet" type="text/css" href="css/main.css?{{.Uncache}}">
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/sprintf.js"></script>
    <script type="text/javascript" src="js/web3.min.js"></script>
    <script type="text/javascript" src="js/ethers.js?{{.Uncache}}"></script>
    <script type="text/javascript" src="js/Chart.min.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyCQ3UTayHzAcoPXJUM3Ag_-FBxII1o6fNg"></script>
    <script type="text/javascript" src="js/gmaps.js?{{.Uncache}}"></script>
    <script type="text/javascript" src="data/sttwABI.js?{{.Uncache}}"></script>
    <script type="text/javascript" src="data/sttwStoreABI.js?{{.Uncache}}"></script>
    <script type="text/javascript" src="data/sntwABI.js?{{.Uncache}}"></script>
    <script type="text/javascript" src="data/solaExchangeABI.js?{{.Uncache}}"></script>
    <script type="text/javascript" src="data/map_style.json?{{.Uncache}}"></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script type="text/javascript">
    if (typeof web3 !== 'undefined') {
        web3 = new Web3(web3.currentProvider);
    } else {
        // set the provider you want from Web3.providers
        web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
    }

    var sttw = new web3.eth.Contract(sttwABI, sttwAddress);
    var sttwStore = new web3.eth.Contract(sttwStoreABI, sttwStoreAddress);
    var sntw1 = new web3.eth.Contract(sntwABI, sntwAddress1);
    var sntw2 = new web3.eth.Contract(sntwABI, sntwAddress2);
    var sntw3 = new web3.eth.Contract(sntwABI, sntwAddress3);
    var solaExchange = new web3.eth.Contract(solaExchangeABI, solaExchangeAddress);

    var feeRate = 0.005;
    var autoSwitchAccount = true; //如要測試多帳號, 可改成false
    var account;
    var currentBlock;
    var dataInitialized = false;
    var eventList = {};
    var orderBook = {};
    var myOrders = {};
    var allProject;
    var myBar;
    var userId;

    var provider = new ethers.providers.JsonRpcProvider('https://kovan.infura.io', true, 42);
    var adminPrivateKey = "0x70394e1a35f52536a07c3dc8dbc3b8f9219511130d8bfaa48518dc497ab00bd8";
    var adminWallet = new ethers.Wallet(adminPrivateKey, provider);
    var userWallet, useRefreshTimer;

    function openTradeDialog(logId) {
        var e = eventList[logId];
        var rv = e.returnValues;

        var type, sntw, sttw, rate;
        if (sttwAddress == rv.tokenGive) {
            type = "Sell";
            sntw = web3.utils.fromWei(rv.amountGet, 'ether');
            sttw = web3.utils.fromWei(rv.amountGive, 'ether');
            rate = sttw / sntw;
        } else {
            type = "Buy";
            sntw = web3.utils.fromWei(rv.amountGive, 'ether');
            sttw = web3.utils.fromWei(rv.amountGet, 'ether');
            rate = sttw / sntw;
        }

        $("#tradeDialogTradeType").text(type);
        $("#tradeDialogDescription").html(sprintf("Order <br/> %s SNTW @ %s SNTW/STTW <br/> Expires in %s blocks", sntw, rate, rv.expires));
        $("#tradeDialogAmountLabel").text("SNTW");
        $("#tradeDialogAmount").val(sntw);
        $("#tradeDialogSTTW").val(sttw);
        $("#tradeDialogFee").val(sttw * feeRate);

        $("#tradeDialog").data("logId", logId);
        $("#tradeDialog").data("rate", rate);

        $("#tradeMask").show();
    }

    function openSignUpDialog() {
        $("#signUpMask").show();
    }

    function openLoginDialog() {
        $("#loginMask").show();
    }

    function loadUserWallet(username, privateKey) {
        userWallet = new ethers.Wallet(privateKey, provider);
        console.log(userWallet);
        $("#userPanel").show();
        $("#username").text(sprintf("Username: %s", username));
        $("#userAccount").text(sprintf("Account: %s", userWallet.address));

        if (useRefreshTimer) {
            clearInterval(useRefreshTimer);
        }
        useRefreshTimer = setInterval(function() {
            userWallet.getBalance().then(function(balance) {
                $("#ethInUserWallet").text(sprintf("ETH: %s", ethers.utils.formatEther(balance)));
            });

            sttw.methods.balanceOf(userWallet.address).call().then(function(r) {
                $("#sttwInUserWallet").text(sprintf("STTW: %s", web3.utils.fromWei(r, 'ether')));
            });

            sntw1.methods.balanceOf(userWallet.address).call().then(function(r) {
                $("#sntwInUserWallet1").text(sprintf("SNTW1: %s", web3.utils.fromWei(r, 'ether')));
            });

            sntw2.methods.balanceOf(userWallet.address).call().then(function(r) {
                $("#sntwInUserWallet2").text(sprintf("SNTW2: %s", web3.utils.fromWei(r, 'ether')));
            });

            sntw3.methods.balanceOf(userWallet.address).call().then(function(r) {
                $("#sntwInUserWallet3").text(sprintf("SNTW3: %s", web3.utils.fromWei(r, 'ether')));
            });

            solaExchange.methods.balanceOf(sttwAddress, userWallet.address).call().then(function(r) {
                $("#sttwInUserSolaExchange").text(sprintf("STTW: %s", web3.utils.fromWei(r, 'ether')));
            });

            solaExchange.methods.balanceOf(sntwAddress1, userWallet.address).call().then(function(r) {
                $("#sntwInUserSolaExchange1").text(sprintf("SNTW1: %s", web3.utils.fromWei(r, 'ether')));
            });

            solaExchange.methods.balanceOf(sntwAddress2, userWallet.address).call().then(function(r) {
                $("#sntwInUserSolaExchange2").text(sprintf("SNTW2: %s", web3.utils.fromWei(r, 'ether')));
            });

            solaExchange.methods.balanceOf(sntwAddress3, userWallet.address).call().then(function(r) {
                $("#sntwInUserSolaExchange3").text(sprintf("SNTW3: %s", web3.utils.fromWei(r, 'ether')));
            });
        }, 1000);

        $("#loginMask").hide();
    }

    function canUseUsername(name) {
        var result;
        $.ajax({
            url: "/checkUsername",
            type: "post",
            dataType: "html",
            data: {
                username: name
            },
            async: false,
            success: function(r) {
                if (r == "true") {
                    result = true;
                } else {
                    result = false;
                    alert(name + " has been used!");
                }
            },
        });

        return result;
    }

    function signUp(username, password, address, privateKey) {
        var result;
        $.ajax({
            url: "/signUp",
            type: "post",
            dataType: "html",
            data: {
                username: username,
                password: password,
                address: address,
                privateKey: privateKey
            },
            async: false,
            success: function(r) {
                if (r == "true") {
                    result = true;
                } else {
                    result = false;
                }
            },
        });

        return result;
    }

    function getPrivateKey(username, password) {
        var privateKey;
        $.ajax({
            url: "/signIn",
            type: "post",
            dataType: "html",
            data: {
                username: username,
                password: password
            },
            async: false,
            success: function(r) {
                if (r == "false") {
                    alert("no this user or password is wrong");
                } else {
                    privateKey = r;
                }
            },
        });

        return privateKey;
    }

    function login(username, password) {
        var privateKey = getPrivateKey(username, password);
        if (privateKey) {
            loadUserWallet(username, privateKey);
            return true;
        }
        return false;
    }

    $(function() {
        $("#signUpConfirm").click(function() {
            var username = $("#signUpName").val();
            var password = $("#signUpPassword").val();

            if (!canUseUsername(username)) {
                return;
            }

            var wallet = ethers.Wallet.createRandom();
            console.log("Address: " + wallet.address);
            console.log("private key: " + wallet.privateKey);
            console.log(wallet);

            if (!signUp(username, password, wallet.address, wallet.privateKey)) {
                return;
            }

            adminWallet.send(wallet.address, ethers.utils.parseEther('0.2'))
                .then(function(transactionHash) {
                    console.log(transactionHash);
                    login(username, password);
                });

            $("#signUpMask").hide();
        });

        $("#loginConfirm").click(function() {
            var username = $("#loginName").val();
            var password = $("#loginPassword").val();

            if (login(username, password)) {
                $("#loginMask").hide();
            }
        });

        $("#orderBook").on('click', "tr", function() {
            var logId = $(this).data("logid");
            if (logId) {
                openTradeDialog(logId);
            }
        });

        $("#myOrders").on('click', "tr", function() {
            var logId = $(this).data("logid");
            if (logId) {
                var e = eventList[logId];
                var rv = e.returnValues;

                var r = e.signature.slice(0, 34);
                var s = '0x' + e.signature.slice(34, 66);
                var v = '0x' + e.signature.slice(66, 68);
                v = web3.utils.toDecimal(v) + 27;

                solaExchange.methods.cancelOrder(rv.tokenGet, rv.amountGet, rv.tokenGive, rv.amountGive, rv.expires, rv.nonce, v, r, s).send({ from: account })
                    .then(function(r) {
                        console.log(r);
                        refreshOrder();
                    });
            }
        });

        $("#tradeConfirm").click(function() {
            var logId = $("#tradeDialog").data("logId");
            var e = eventList[logId];
            var rv = e.returnValues;

            var r = e.signature.slice(0, 34);
            var s = '0x' + e.signature.slice(34, 66);
            var v = '0x' + e.signature.slice(66, 68);
            v = web3.utils.toDecimal(v) + 27;

            var amountGet;
            if (sttwAddress == rv.tokenGive) {
                amountGet = web3.utils.toWei($("#tradeDialogAmount").val(), 'ether');
            } else {
                amountGet = web3.utils.toWei($("#tradeDialogSTTW").val(), 'ether');
            }

            solaExchange.methods.trade(rv.tokenGet, rv.amountGet, rv.tokenGive, rv.amountGive, rv.expires, rv.nonce, rv.user, v, r, s, amountGet).send({ from: account })
                .then(function(r) {
                    console.log(r);
                    refreshOrder();
                    refreshTrade();
                    freshPriceChart();
                });

            $("#tradeMask").hide();
        });

        $("#tradeDialogAmount").bind('keyup mouseup', function() {
            var sttw = $("#tradeDialog").data("rate") * $("#tradeDialogAmount").val();
            $("#tradeDialogSTTW").val(sttw);
            $("#tradeDialogFee").val(sttw * feeRate);
        });

        $("#projects").on("click", "tr", function() {
            var id = $(this).data("id");
            var p = allProject.find(function(a) {
                return a.id == id;
            });

            var map = new GMaps({
                div: '#map',
                lat: p.coord.lat,
                lng: p.coord.lng,
                zoom: 7,
                options: {
                    styles: mapStyle,
                    mapTypeControl: false,
                    fullscreenControl: false,
                    streetViewControl: false
                }
            });

            var m = map.addMarker({
                lat: p.coord.lat,
                lng: p.coord.lng,
                title: p.name,
                infoWindow: {
                    content: sprintf('<h8>%s</h8><div>裝置容量: %s(kW)</div>', p.name, p.capacity),
                    maxWidth: 100
                }
            });

            console.log(p.values);

            var values = [];
            for (var dt in p.values) {
                values.push({ date: dt, value: p.values[dt] });
            }

            values.sort(function(a, b) {
                if (a.date < b.date) {
                    return -1;
                } else if (a.date > b.date) {
                    return 1;
                } else {
                    return 0;
                }
            });

            var lables = [];
            var datas = [];
            values.forEach(function(item, index) {
                lables.push(item.date);
                datas.push(item.value);
            });

            var ctx = $("#chart-area");
            ctx.empty;

            if (myBar) {
                myBar.destroy();
            }
            myBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: lables,
                    datasets: [{
                        label: sprintf('%s - 日發電量(kW)', p.name),
                        data: datas,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });

        });

        init();

        web3.eth.getAccounts().then(function(r) {
            account = r[0];
            $("#account").text(sprintf("Account: %s", account));
        });

        setInterval(function() {
            if (autoSwitchAccount) {
                web3.eth.getAccounts().then(function(r) {
                    if (account == r[0]) {
                        return;
                    }

                    account = r[0];
                    $("#account").text(sprintf("Account: %s", account));
                    dataInitialized = false;
                });
            }

            if (account) {
                web3.eth.getBlockNumber().then(function(r) {
                    currentBlock = r;
                    $("#currentBlock").text(sprintf("SolaExchange CurrentBlock: %s", currentBlock));

                    if (!dataInitialized) {
                        dataInitialized = true;
                        refreshOrder();
                        refreshTrade();
                        freshPriceChart();
                        refreshTransfer();
                    } else {
                        refreshExpires();
                    }
                });

                web3.eth.getBalance(account).then(function(r) {
                    $("#ethInWallet").text(sprintf("ETH: %s", web3.utils.fromWei(r, 'ether')));
                });

                sttw.methods.balanceOf(account).call().then(function(r) {
                    $("#sttwInWallet").text(sprintf("STTW: %s", web3.utils.fromWei(r, 'ether')));
                });

                sntw1.methods.balanceOf(account).call().then(function(r) {
                    $("#sntwInWallet1").text(sprintf("SNTW1: %s", web3.utils.fromWei(r, 'ether')));
                });

                sntw2.methods.balanceOf(account).call().then(function(r) {
                    $("#sntwInWallet2").text(sprintf("SNTW2: %s", web3.utils.fromWei(r, 'ether')));
                });

                sntw3.methods.balanceOf(account).call().then(function(r) {
                    $("#sntwInWallet3").text(sprintf("SNTW3: %s", web3.utils.fromWei(r, 'ether')));
                });

                solaExchange.methods.balanceOf(sttwAddress, account).call().then(function(r) {
                    $("#sttwInSolaExchange").text(sprintf("STTW: %s", web3.utils.fromWei(r, 'ether')));
                });

                solaExchange.methods.balanceOf(sntwAddress1, account).call().then(function(r) {
                    $("#sntwInSolaExchange1").text(sprintf("SNTW1: %s", web3.utils.fromWei(r, 'ether')));
                });

                solaExchange.methods.balanceOf(sntwAddress2, account).call().then(function(r) {
                    $("#sntwInSolaExchange2").text(sprintf("SNTW2: %s", web3.utils.fromWei(r, 'ether')));
                });

                solaExchange.methods.balanceOf(sntwAddress3, account).call().then(function(r) {
                    $("#sntwInSolaExchange3").text(sprintf("SNTW3: %s", web3.utils.fromWei(r, 'ether')));
                });
            }
        }, 1000);
    });

    function init() {
        connectToServer();

        var map = new GMaps({
            div: '#map',
            zoom: 7,
            lat: 23.6662529,
            lng: 120.8278127,
            options: {
                styles: mapStyle,
                mapTypeControl: false,
                fullscreenControl: false,
                streetViewControl: false
            }
        });

        $.getJSON("https://sola-api.herokuapp.com/api/v1/projects", function(data) {
            allProject = data;
            var testType = 0;
            allProject.forEach(function(item, index) {
                $("#projects tr:last").after(sprintf("<tr data-id='%s'><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>", item.id, "SNTW" + (++testType), item.name, item.date.slice(0, 10), item.capacity, item.decay));

                var p = allProject.find(function(a) {
                    return a.id == item.id;
                });
                p.values = {};
            });
        });
        $.getJSON("https://sola-api.herokuapp.com/api/v1/values", function(json) {
            console.log(json);
            json.forEach(function(item, index) {
                var p = allProject.find(function(a) {
                    return a.id == item.id;
                });

                var dt = item.dt.slice(0, 10);
                var v = p.values[dt];
                if (v) {
                    v += item.value;
                    p.values[dt] = v;
                } else {
                    p.values[dt] = item.value;
                }
            });
            console.log(allProject);
        });
    }

    function btnApprove() {
        var token = $("#token").val();
        var tokenContract;
        switch (token) {
            case "0":
                tokenContract = sttw;
                break;
            case "1":
                tokenContract = sntw1;
                break;
            case "2":
                tokenContract = sntw2;
                break;
            case "3":
                tokenContract = sntw3;
                break;
        }

        var v = $("#walletToken").val();
        tokenContract.methods.approve(solaExchangeAddress, web3.utils.toWei(v, 'ether')).send({ from: account })
            .then(console.log);
    }

    function btnDepositToken() {
        var token = $("#token").val();
        var tokenAddress;
        switch (token) {
            case "0":
                tokenAddress = sttwAddress;
                break;
            case "1":
                tokenAddress = sntwAddress1;
                break;
            case "2":
                tokenAddress = sntwAddress2;
                break;
            case "3":
                tokenAddress = sntwAddress3;
                break;
        }

        var v = $("#walletToken").val();
        solaExchange.methods.depositToken(tokenAddress, web3.utils.toWei(v, 'ether')).send({ from: account })
            .then(console.log);
    }

    function btnWithdrawToken() {
        var token = $("#token").val();
        var tokenAddress;
        switch (token) {
            case "0":
                tokenAddress = sttwAddress;
                break;
            case "1":
                tokenAddress = sntwAddress1;
                break;
            case "2":
                tokenAddress = sntwAddress2;
                break;
            case "3":
                tokenAddress = sntwAddress3;
                break;
        }

        var v = $("#walletToken").val();
        solaExchange.methods.withdrawToken(tokenAddress, web3.utils.toWei(v, 'ether')).send({ from: account })
            .then(console.log);
    }

    function btnOrderBuySNTW() {
        var token = $("#orderToken").val();
        var sntwAddress;
        switch (token) {
            case "1":
                sntwAddress = sntwAddress1;
                break;
            case "2":
                sntwAddress = sntwAddress2;
                break;
            case "3":
                sntwAddress = sntwAddress3;
                break;
        }

        var get = $("#orderSntwToken").val();
        var give = $("#orderSttwToken").val();
        var expires = parseInt($('#orderExpires').val()) + currentBlock;
        var nonce = Date.now();
        solaExchange.methods.order(sntwAddress, web3.utils.toWei(get, 'ether'), sttwAddress, web3.utils.toWei(give, 'ether'), expires, nonce).send({ from: account })
            .then(function(r) {
                console.log(r);
                refreshOrder();
            });
    }

    function btnOrderSellSNTW() {
        var token = $("#orderToken").val();
        var sntwAddress;
        switch (token) {
            case "1":
                sntwAddress = sntwAddress1;
                break;
            case "2":
                sntwAddress = sntwAddress2;
                break;
            case "3":
                sntwAddress = sntwAddress3;
                break;
        }

        var get = $("#orderSttwToken").val();
        var give = $("#orderSntwToken").val();
        var expires = parseInt($('#orderExpires').val()) + currentBlock;
        var nonce = Date.now();
        solaExchange.methods.order(sttwAddress, web3.utils.toWei(get, 'ether'), sntwAddress, web3.utils.toWei(give, 'ether'), expires, nonce).send({ from: account })
            .then(function(r) {
                console.log(r);
                refreshOrder();
            });
    }

    function refreshOrder() {
        solaExchange.getPastEvents('Order', {
                //filter: { myIndexedParam: [20, 23], myOtherIndexedParam: '0x123456789...' }, // Using an array means OR: e.g. 20 or 23
                fromBlock: 0,
                toBlock: 'latest'
            })
            .then(function(events) {
                orderBook = { count: 0, orders: {} };
                myOrders = { count: 0, orders: {} };

                for (var i = 0; i < events.length; ++i) {
                    var e = events[i];
                    var rv = e.returnValues;
                    //console.log(e);
                    var order, rate, sntw, sntwAddress, sttw, remained;
                    if (sttwAddress == rv.tokenGive) {
                        order = "BUY";
                        sntwAddress = rv.tokenGet;
                        sntw = web3.utils.fromWei(rv.amountGet, 'ether');
                        sttw = web3.utils.fromWei(rv.amountGive, 'ether');
                        rate = sttw / sntw;
                        color = "lightgreen";
                    } else {
                        order = "SELL";
                        sntwAddress = rv.tokenGive;
                        sntw = web3.utils.fromWei(rv.amountGive, 'ether');
                        sttw = web3.utils.fromWei(rv.amountGet, 'ether');
                        rate = sttw / sntw;
                        color = "red";
                    }

                    var expires = (rv.expires > currentBlock) ? rv.expires - currentBlock : 0;

                    if (expires > 0) {
                        orderBook.count += 1;
                        orderBook.orders[e.id] = { logId: e.id, order: order, sntw: sntw, sntwAddress: sntwAddress, sttw: sttw, rate: rate, color: color, nonce: rv.nonce, expires: expires };
                    }

                    if (rv.user == account) {
                        myOrders.count += 1;
                        myOrders.orders[e.id] = { logId: e.id, order: order, sntw: sntw, sntwAddress: sntwAddress, sttw: sttw, rate: rate, color: color, nonce: rv.nonce, expires: expires };
                    }

                    eventList[e.id] = e;
                    (function(event) {
                        solaExchange.methods.amountFilled(rv.tokenGet, rv.amountGet, rv.tokenGive, rv.amountGive, rv.expires, rv.nonce, rv.user, 0, "0x0", "0x0").call()
                            .then(function(filled) {
                                var need1 = updateOrderData(orderBook, event.id, filled);
                                var need2 = updateOrderData(myOrders, event.id, filled);
                                if (!(need1 || need2)) {
                                    delete eventList[event.id];
                                }

                                if (orderBook.count == 0) {
                                    var sortable = sortForOrderBook(orderBook.orders);

                                    $("#orderBook tr:gt(0)").remove();
                                    for (var s in sortable) {
                                        var o = sortable[s][0];
                                        $("#orderBook tr:last").after(sprintf("<tr id='o_%s' title='click to trade.' style='background: %s' data-logid='%s'><td>%s</td><td>%s</td><td>%s</td><td>[%s/%s]</td><td>%s</td><td>%s</td></tr>", o.nonce, o.color, o.logId, o.order, getTokenName(o.sntwAddress), o.rate, o.remained, o.sntw, o.sttw, o.expires));
                                    }
                                }

                                if (myOrders.count == 0) {
                                    $("#myOrders tr:gt(0)").remove();
                                    for (var id in myOrders.orders) {
                                        var o = myOrders.orders[id];
                                        $("#myOrders tr:last").after(sprintf("<tr id='mo_%s' title='click to cancel.' style='background: %s' data-logid='%s'><td>%s</td><td>%s</td><td>%s</td><td>[%s/%s]</td><td>%s</td><td>%s</td><td>%s</td></tr>", o.nonce, (o.expires > 0 ? 'lightblue' : 'lightgrey'), o.logId, o.order, getTokenName(o.sntwAddress), o.rate, o.remained, o.sntw, o.sttw, o.expires, (o.expires > 0 ? 'alive' : 'expired')));
                                    }
                                }
                            });
                    })(e);
                }
            });
    }

    function getTokenName(address) {
        switch (address) {
            case sttwAddress:
                return "STTW";
            case sntwAddress1:
                return "SNTW1";
            case sntwAddress2:
                return "SNTW2";
            case sntwAddress3:
                return "SNTW3";
            default:
                alert("unknown token type");
                return "unknown";
        }
    }

    function updateOrderData(orderData, eventId, filled) {
        if (orderData.orders[eventId]) {
            orderData.count -= 1;

            var o = orderData.orders[eventId];
            if (o.order == "BUY") {
                filled = web3.utils.fromWei(filled);
                o.remained = o.sntw - filled;
            } else {
                filled = web3.utils.fromWei(filled);
                o.remained = (o.sttw - filled) * o.sntw / o.sttw;
            }

            if (o.remained == 0) {
                delete orderData.orders[eventId];
            } else {
                return true; //需要保留event log
            }
        }

        return false;
    }

    function sortForOrderBook(orders) {
        var sortable = [];
        for (var id in orders) {
            var o = orders[id];
            sortable.push([o, o.order, o.rate]);
        }

        sortable.sort(function(a, b) {
            if (a[1] != b[1]) {
                return (a[1] < b[1]) ? 1 : -1;
            } else {
                return b[2] - a[2];
            }
        });

        return sortable;
    }

    function refreshTrade() {
        solaExchange.getPastEvents('Trade', {
                //filter: { myIndexedParam: [20, 23], myOtherIndexedParam: '0x123456789...' }, // Using an array means OR: e.g. 20 or 23
                fromBlock: 0,
                toBlock: 'latest'
            })
            .then(function(trades) {
                $("#myTrades tr:gt(0)").remove();

                for (var i = 0; i < trades.length; i++) {
                    var rv = trades[i].returnValues;
                    if (rv.get == account || rv.give == account) {
                        var order, rate, sntw, sntwAddress, sttw;
                        if (sttwAddress == rv.tokenGive) {
                            order = (rv.get == account) ? "BUY" : "SELL";
                            sntwAddress = rv.tokenGet;
                            sntw = web3.utils.fromWei(rv.amountGet, 'ether');
                            sttw = web3.utils.fromWei(rv.amountGive, 'ether');
                            rate = sttw / sntw;
                        } else {
                            order = (rv.give == account) ? "BUY" : "SELL";
                            sntwAddress = rv.tokenGive;
                            sntw = web3.utils.fromWei(rv.amountGive, 'ether');
                            sttw = web3.utils.fromWei(rv.amountGet, 'ether');
                            rate = sttw / sntw;
                        }

                        $("#myTrades tr:last").after(sprintf("<tr style='background: lightblue'><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>", order, getTokenName(sntwAddress), rate, sntw, sttw));
                    }
                }


                $("#volumns tr:gt(0)").remove();

                var volumns = {};

                for (var i = 0; i < trades.length; i++) {
                    var rv = trades[i].returnValues;
                    if (sttwAddress == rv.tokenGive) {
                        var address = rv.tokenGet;
                        var amount = web3.utils.fromWei(rv.amountGet, 'ether');
                        var price = web3.utils.fromWei(rv.amountGive, 'ether');
                        var bid = price / amount;

                        var v = volumns[address];
                        if (v) {
                            v.amount += parseFloat(amount);
                            v.bid = bid;
                        } else {
                            volumns[address] = { amount: parseFloat(amount), bid: bid };
                        }
                    } else {
                        var address = rv.tokenGive;
                        var amount = web3.utils.fromWei(rv.amountGive, 'ether');
                        var price = web3.utils.fromWei(rv.amountGet, 'ether');
                        var offer = price / amount;

                        var v = volumns[address];
                        if (v) {
                            v.amount += parseFloat(amount);
                            v.offer = offer;
                        } else {
                            volumns[address] = { amount: parseFloat(amount), offer: offer };
                        }
                    }
                }

                for (var address in volumns) {
                    var v = volumns[address];

                    $("#volumns tr:last").after(sprintf("<tr style='background: lightblue'><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>", getTokenName(address), v.amount, v.bid ? v.bid : "", v.offer ? v.offer : ""));
                }
            });
    }

    function refreshExpires() {
        $("#orderBook tr").each(function() {
            var logId = $(this).data("logid");
            if (logId) {
                var e = eventList[logId];
                var rv = e.returnValues;
                var expires = (rv.expires > currentBlock) ? rv.expires - currentBlock : 0;

                $(this).find('td:last-child').text(expires);
                if (expires == 0) {
                    $(this).hide();
                }
            }
        });

        $("#myOrders tr").each(function() {
            var logId = $(this).data("logid");
            if (logId) {
                var e = eventList[logId];
                var rv = e.returnValues;
                var expires = (rv.expires > currentBlock) ? rv.expires - currentBlock : 0;

                $(this).find('td:nth-last-child(2)').text(expires);
                if (expires == 0) {
                    $(this).find('td:last-child').text("expired");
                    $(this).css("background", "lightgrey");
                }
            }
        });
    }

    function btnTransfer() {
        var token = $("#transferToken").val();
        var amount = $("#transferTokenAmount").val();
        var address = $("#transferAddress").val();
        switch (token) {
            case "0":
                token = sttwAddress;
                break;
            case "1":
                token = sntwAddress1;
                break;
            case "2":
                token = sntwAddress2;
                break;
            case "3":
                token = sntwAddress3;
                break;
            default:
                alert("unknown token type");
                return;
        }

        amount = web3.utils.toWei(amount, 'ether');
        solaExchange.methods.transferToken(token, amount, address).send({ from: account })
            .then(function(r) {
                console.log(r);
            });
    }

    function refreshTransfer() {
        solaExchange.getPastEvents('Transfer', {
                //filter: { myIndexedParam: [20, 23], myOtherIndexedParam: '0x123456789...' }, // Using an array means OR: e.g. 20 or 23
                fromBlock: 0,
                toBlock: 'latest'
            })
            .then(function(transfer) {
                console.log(transfer);
                $("#myTransferFrom tr:gt(0)").remove();
                $("#myTransferTo tr:gt(0)").remove();

                for (var i = 0; i < transfer.length; i++) {
                    var rv = transfer[i].returnValues;
                    var token = getTokenName(rv.token)
                    var amount = web3.utils.fromWei(rv.amount, 'ether');

                    if (rv.receiver == account) {
                        $("#myTransferFrom tr:last").after(sprintf("<tr style='background: lightblue'><td>%s</td><td>%s</td><td>%s</td></tr>", token, amount, rv.user));
                    }

                    if (rv.user == account) {
                        $("#myTransferTo tr:last").after(sprintf("<tr style='background: lightblue'><td>%s</td><td>%s</td><td>%s</td></tr>", token, amount, rv.receiver));
                    }
                }
            });
    }

    function buySTTW() {
        if (!userWallet) {
            alert("no user login");
            return;
        }

        $.ajax({
            url: "/buy",
            type: "post",
            dataType: "html",
            data: {
                userId: userId
            },
            success: function(result) {
                var data = JSON.parse(result);
                console.log(data);
                for (var name in data) {
                    $(sprintf("input[name='%s']", name)).val(data[name]);
                }

                $("#formCreditCard").submit();
            },
        });
    }

    function buy(wallet, amount) {
        var contract = new ethers.Contract(sttwStoreAddress, sttwStoreABI, adminWallet);
        var txid;
        contract.buyToken(wallet.address, ethers.utils.parseEther(amount)).then((transaction) => {
            console.log("buy");
            console.log(transaction);
            txid = transaction.hash;
            return adminWallet.provider.waitForTransaction(txid)
        }).then((transaction) => {
            console.log('Transaction Minded: ' + transaction.hash);
            console.log(transaction);
            return adminWallet.provider.getTransaction(txid);
        }).then((transaction) => {
            console.log(transaction);
            return contract.balanceOf(wallet.address);
        }).then((result) => {
            console.log(result);
            approve(wallet, amount);
        });
    }

    function approve(wallet, amount) {
        var contract = new ethers.Contract(sttwAddress, sttwABI, wallet);
        var txid;
        contract.approve(solaExchangeAddress, ethers.utils.parseEther(amount)).then((transaction) => {
            console.log("approve");
            console.log(transaction);
            txid = transaction.hash;
            return wallet.provider.waitForTransaction(txid)
        }).then((transaction) => {
            console.log('Transaction Minded: ' + transaction.hash);
            console.log(transaction);
            return wallet.provider.getTransaction(txid);
        }).then((transaction) => {
            console.log(transaction);
            return contract.balanceOf(wallet.address);
        }).then((result) => {
            console.log(result);
            deposit(wallet, amount);
        });
    }

    function deposit(wallet, amount) {
        var contract = new ethers.Contract(solaExchangeAddress, solaExchangeABI, wallet);
        var txid;
        contract.depositToken(sttwAddress, ethers.utils.parseEther(amount)).then((transaction) => {
            console.log("deposit");
            console.log(transaction);
            txid = transaction.hash;
            return wallet.provider.waitForTransaction(txid)
        }).then((transaction) => {
            console.log('Transaction Minded: ' + transaction.hash);
            console.log(transaction);
            return wallet.provider.getTransaction(txid);
        }).then((transaction) => {
            console.log(transaction);
            return contract.balanceOf(sttwAddress, wallet.address);
        }).then((result) => {
            console.log(result);
        });
    }

    function connectToServer() {
        var wsuri = "ws://{{.IP}}:{{.Port}}/WS";
        sock = new WebSocket(wsuri);

        sock.onopen = function() {
            console.log("connected to " + wsuri);
        };

        sock.onclose = function(e) {
            console.log("connection closed (" + e.code + ")");
            alert("斷線了，準備重連");
            location.reload();
        };

        sock.onmessage = function(e) {
            console.log(e.data);
            var packet = JSON.parse(e.data);
            var c = JSON.parse(packet.content);

            switch (packet.opcode) {
                case "OP_INIT":
                    userId = c.userID;
                    //alert(sprintf("you temp ID:%s", userId));
                    break;
                case "OP_TRADE_OK":
                    alert(c.msg + ", 約30秒後入帳");
                    buy(userWallet, "100");
                    /*
                    sttwStore.methods.buyToken(account, web3.utils.toWei(100, 'ether')).send({ from: account })
                        .then(function(r) {
                            console.log(r);
                            sttw.methods.approve(solaExchangeAddress, web3.utils.toWei(100, 'ether')).send({ from: account })
                                .then(function(r) {
                                    console.log(r);
                                    solaExchange.methods.depositToken(sttwAddress, web3.utils.toWei(100, 'ether')).send({ from: account })
                                        .then(function(r) {
                                            console.log(r);
                                        });
                                });
                        });

                    */
                    break;
                default:
                    console.log("unknown packet");
                    break;
            }
        };
    }

    function freshPriceChart() {
        solaExchange.getPastEvents('Trade', {
                //filter: { myIndexedParam: [20, 23], myOtherIndexedParam: '0x123456789...' }, // Using an array means OR: e.g. 20 or 23
                fromBlock: 4642724,
                toBlock: 'latest'
            })
            .then(function(trades) {
                var data = [];

                for (var i = 0; i < trades.length; i++) {
                    var blockNumber = trades[i].blockNumber;
                    var rv = trades[i].returnValues;
                    var address, amount, price;
                    if (sttwAddress == rv.tokenGive) {
                        address = rv.tokenGet;
                        amount = web3.utils.fromWei(rv.amountGet, 'ether');
                        price = web3.utils.fromWei(rv.amountGive, 'ether');
                    } else {
                        address = rv.tokenGive;
                        amount = web3.utils.fromWei(rv.amountGive, 'ether');
                        price = web3.utils.fromWei(rv.amountGet, 'ether');
                    }

                    var rate = price / amount;

                    var timeIndex = Math.floor(blockNumber / 10);
                    if (data.length == 0 || data[data.length - 1][0] != timeIndex) {
                        data.push([timeIndex, rate, rate, rate, rate]);
                    } else {
                        var stick = data[data.length - 1];
                        if (rate > stick[2]) {
                            stick[2] = rate;
                        }
                        if (rate < stick[3]) {
                            stick[3] = rate;
                        }
                        stick[4] = rate;
                    }
                }

                Highcharts.stockChart('container', {
                    rangeSelector: {
                        selected: 1
                    },

                    title: {
                        text: 'SNTW Price'
                    },

                    series: [{
                        type: 'candlestick',
                        name: 'SNTW Price',
                        data: data
                    }]
                });
            });
    }
    </script>
</head>

<body>
    <table style="width:100%">
        <tr>
            <td style="width:20%; border-style: solid; border-width: 1px; vertical-align: top;">
                <div>一般投資人:</div>
                <button type="button" onclick="openSignUpDialog();">Sign Up</button>
                <button type="button" onclick="openLoginDialog();">Login</button>
                <button type="button" onclick="buySTTW();">購買100STTW</button>
                <div id="userPanel" hidden=true>
                    <div id="username"></div>
                    <br/>
                    <div id="userAccount"></div>
                    <br/>
                    <label>In Wallet (will be hidden):</label>
                    <div id="ethInUserWallet"></div>
                    <div id="sttwInUserWallet"></div>
                    <div id="sntwInUserWallet1"></div>
                    <div id="sntwInUserWallet2"></div>
                    <div id="sntwInUserWallet3"></div>
                    <br/>
                    <label>In SolaExchange:</label>
                    <div id="sttwInUserSolaExchange"></div>
                    <div id="sntwInUserSolaExchange1"></div>
                    <div id="sntwInUserSolaExchange2"></div>
                    <div id="sntwInUserSolaExchange3"></div>
                    <br/>
                    <label>TODO List:</label>
                    <div>Buy SNTW</div>
                    <div>Sell SNTW</div>
                    <div>Funds</div>
                </div>
            </td>
            <td style="width:80%; border-style: solid; border-width: 1px; vertical-align: top;">
                <div>交易所:</div>
                <div id="currentBlock"></div>
                <div id="account"></div>
                <br/>
                <table>
                    <tr style="vertical-align: top;">
                        <td style="padding-right: 30px;">
                            <label>In Wallet:</label>
                            <div id="ethInWallet"></div>
                            <div id="sttwInWallet"></div>
                            <div id="sntwInWallet1"></div>
                            <div id="sntwInWallet2"></div>
                            <div id="sntwInWallet3"></div>
                        </td>
                        <td style="padding-right: 30px;">
                            <label>In SolaExchange:</label>
                            <div id="sttwInSolaExchange"></div>
                            <div id="sntwInSolaExchange1"></div>
                            <div id="sntwInSolaExchange2"></div>
                            <div id="sntwInSolaExchange3"></div>
                        </td>
                        <td style="padding-right: 30px;">
                            <label>TODO List:</label>
                            <div>SNTW Chart</div>
                            <div>SNTW Volumns</div>
                            <div>Funds</div>
                        </td>
                    </tr>
                </table>
                </div>
                <hr/>
                <select id="token">
                    <option value="0">STTW</option>
                    <option value="1">SNTW1</option>
                    <option value="2">SNTW2</option>
                    <option value="3">SNTW3</option>
                </select>
                <input id="walletToken" type="number" value=0></input>
                <button type="button" onclick="btnApprove()">Approve</button>
                <button type="button" onclick="btnDepositToken()">Deposit</button>
                <button type="button" onclick="btnWithdrawToken()">Withdraw</button>
                <hr/>
                <!--select id="generateToken">
                <option value="1">SNTW1</option>
                <option value="2">SNTW2</option>
                <option value="3">SNTW3</option>
            </select>
            <input id="sntwToken" type="number" value=0></input>
            <button type="button" onclick="btnGenerateSNTW()">Genarate SNTW</button>
            <hr/-->
                <select id="transferToken">
                    <option value="0">STTW</option>
                    <option value="1">SNTW1</option>
                    <option value="2">SNTW2</option>
                    <option value="3">SNTW3</option>
                </select>
                <label>:</label>
                <input id="transferTokenAmount" type="number" value=0></input>
                <label>Receiver Address:</label>
                <input id="transferAddress" type="text"></input>
                <button type="button" onclick="btnTransfer()">transfer</button>
                <hr/>
                <select id="orderToken">
                    <option value="1">SNTW1</option>
                    <option value="2">SNTW2</option>
                    <option value="3">SNTW3</option>
                </select>
                <label>:</label>
                <input id="orderSntwToken" type="number" value=0></input>
                <label>STTW:</label>
                <input id="orderSttwToken" type="number" value=0></input>
                <label>Expires:</label>
                <input id="orderExpires" type="number" value=0></input>
                <button type="button" onclick="btnOrderBuySNTW()">order (buy SNTW)</button>
                <button type="button" onclick="btnOrderSellSNTW()">order (sell SNTW)</button>
                <hr/>
                <div style="overflow: auto;">
                    <span style="float: left">
                        <div id="container" style="min-width: 300px"></div>
                    </span>
                    <span style="float: left">
                        <label>Order Book</label>
                        <table id="orderBook">
                            <tr>
                                <th>Order</th>
                                <th>Type</th>
                                <th>SNTW/STTW</th>
                                <th>SNTW</th>
                                <th>STTW</th>
                                <th>EXPIRES</th>
                            </tr>
                        </table>
                    </span>
                    <span style="float: left">
                        <label>Volumns</label>
                        <table id="volumns">
                            <tr>
                                <th>Pair</th>
                                <th>Daily</th>
                                <th>Bid</th>
                                <th>Offer</th>
                            </tr>
                        </table>
                    </span>
                    <span style="float: left">
                    <label>My Orders</label>
                        <table id="myOrders">
                            <tr>
                                <th>Order</th>
                                <th>Type</th>
                                <th>SNTW/STTW</th>
                                <th>SNTW</th>
                                <th>STTW</th>
                                <th>EXPIRES</th>
                                <th>STATUS</th>
                            </tr>
                        </table>
                    </span>
                    <span style="float: left">
                        <label>My Trades</label>
                        <table id="myTrades">
                            <tr>
                                <th>Trade</th>
                                <th>Type</th>
                                <th>SNTW/STTW</th>
                                <th>SNTW</th>
                                <th>STTW</th>
                            </tr>
                        </table>
                    </span>
                    <span style="float: left">
                        <label>My Transfer From</label>
                        <table id="myTransferFrom">
                            <tr>
                                <th>Token</th>
                                <th>Amount</th>
                                <th>Sender</th>
                            </tr>
                        </table>
                    </span>
                    <span style="float: left">
                        <label>My Transfer To</label>
                        <table id="myTransferTo">
                            <tr>
                                <th>Token</th>
                                <th>Amount</th>
                                <th>Receiver</th>
                            </tr>
                        </table>
                    </span>
                </div>
            </td>
        </tr>
    </table>
    <hr/>
    <div style="overflow: auto;">
        <span style="float: left">
            <label>Projects</label>
            <table id="projects">
                <tr>
                    <th>Type</th>
                    <th>電廠代號</th>
                    <th>發電起始日</th>
                    <th>裝置容量 (kW)</th>
                    <th>發電年衰減率</th>
                </tr>
            </table>
        </span>
        <div id="map" style="float: left">
        </div>
        <div class="box" style="float: left; width: 800px;">
            <canvas id="chart-area" class="zone"></canvas>
        </div>
    </div>
    <div id="tradeMask" hidden="true">
        <div id="tradeDialog">
            <label id="tradeDialogTradeType"></label>
            <hr/>
            <div id="tradeDialogDescription"></div>
            <br/>
            <div id="tradeDialogAmountLabel"></div>
            <input id="tradeDialogAmount" type="number"></input>
            <br/>
            <br/>
            <div>STTW</div>
            <input id="tradeDialogSTTW" type="number" disabled></input>
            <br/>
            <br/>
            <div>Fee (STTW)</div>
            <input id="tradeDialogFee" type="number" disabled></input>
            <br/>
            <br/>
            <hr/>
            <button id="tradeCancel" type="button" onclick="$('#tradeMask').hide();">cancel</button>
            <button id="tradeConfirm" type="button">trade</button>
        </div>
    </div>
    <div id="signUpMask" hidden="true">
        <div id="signUpDialog">
            <label>Username:</label>
            <input id="signUpName" type="text"></input>
            <br/>
            <br/>
            <label>Password:</label>
            <input id="signUpPassword" type="password"></input>
            <hr/>
            <button id="signUpCancel" type="button" onclick="$('#signUpMask').hide();">Cancel</button>
            <button id="signUpConfirm" type="button">Sign Up</button>
        </div>
    </div>
    <div id="loginMask" hidden="true">
        <div id="loginDialog">
            <label>Username:</label>
            <input id="loginName" type="text"></input>
            <br/>
            <br/>
            <label>Password:</label>
            <input id="loginPassword" type="password"></input>
            <hr/>
            <button id="loginCancel" type="button" onclick="$('#loginMask').hide();">Cancel</button>
            <button id="loginConfirm" type="button">Login</button>
        </div>
    </div>
    <div hidden=true>
        <form id="formCreditCard" method="post" accept-charset="UTF-8" action="https://payment-stage.allpay.com.tw/Cashier/AioCheckOut/V4" target="_blank">
            MerchantID 商店代號:
            <input type="text" name="MerchantID" value="2000132" />
            <br /> MerchantTradeNo 商店交易編號:
            <input type="text" name="MerchantTradeNo" value="DX201711040035410390" />
            <br /> MerchantTradeDate 商店交易時間:
            <input type="text" name="MerchantTradeDate" value="2017/11/04 00:35:41" />
            <br /> PaymentType 交易類型:
            <input type="text" name="PaymentType" value="aio" />
            <br /> TotalAmount 交易金額:
            <input type="text" name="TotalAmount" value="5" />
            <br /> TradeDesc 交易描述:
            <input type="text" name="TradeDesc" value="建立信用卡測試訂單" />
            <br /> ItemName 商品名稱:
            <input type="text" name="ItemName" value="MacBook 30元X2#iPhone6s 40元X1" />
            <br /> ReturnURL 付款完成通知回傳網址:
            <input type="text" name="ReturnURL" value="https://developers.allpay.com.tw/AioMock/MerchantReturnUrl" />
            <br /> ChoosePayment 預設付款方式:
            <input type="text" name="ChoosePayment" value="Credit" />
            <br /> 會員商店代碼:
            <input type="text" name="StoreID" value="" />
            <br /> ClientBackURL Client端返回廠商網址:
            <input type="text" name="ClientBackURL" value="https://developers.allpay.com.tw/AioMock/MerchantClientBackUrl" />
            <br /> CreditInstallment 刷卡分期期數:
            <input type="text" name="CreditInstallment" value="" />
            <br /> InstallmentAmount 使用刷卡分期的付款金額:
            <input type="text" name="InstallmentAmount" value="" />
            <br /> Redeem 信用卡是否使用紅利折抵:
            <input type="text" name="Redeem" value="" />
            <br /> CheckMacValue 簽章類型:
            <input type="text" name="EncryptType" value="1" />
            <br /> CheckMacValue 檢查碼:
            <input type="text" name="CheckMacValue" value="72CF507EF67364245B143A5C52D24018B431322B82FB10E2548676CC385BF59E" />
            <br />
        </form>
    </div>
</body>

</html>