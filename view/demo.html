<!DOCTYPE html>
<html>

<head>
    <title>Demo</title>
    <link rel="stylesheet" type="text/css" href="css/main.css?{{.Uncache}}">
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/sprintf.js"></script>
    <script type="text/javascript" src="js/web3.min.js"></script>
    <script type="text/javascript" src="data/slsABI.js?{{.Uncache}}"></script>
    <script type="text/javascript" src="data/solaExchangeABI.js?{{.Uncache}}"></script>
    <script type="text/javascript">
    if (typeof web3 !== 'undefined') {
        web3 = new Web3(web3.currentProvider);
    } else {
        // set the provider you want from Web3.providers
        web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
    }

    var ethAddress = '0x0000000000000000000000000000000000000000';
    var feeRate = 0.005;
    var autoSwitchAccount = true; //如要測試多帳號, 可改成false
    var account;
    var currentBlock;
    var dataInitialized = false;
    var sls = new web3.eth.Contract(slsABI, slsAddress);
    var solaExchange = new web3.eth.Contract(solaExchangeABI, solaExchangeAddress);
    var eventList = {};
    var orderBook = {};
    var myOrders = {};

    function openTradeDialog(logId) {
        var e = eventList[logId];
        var rv = e.returnValues;

        var type, sls, eth, rate;
        if (slsAddress == rv.tokenGet) {
            type = "Sell";
            sls = weiToSls(rv.amountGet);
            eth = web3.utils.fromWei(rv.amountGive, 'ether');
            rate = eth / sls;
        } else {
            type = "Buy";
            sls = weiToSls(rv.amountGive);
            eth = web3.utils.fromWei(rv.amountGet, 'ether');
            rate = eth / sls;
        }

        $("#tradeDialogTradeType").text(type);
        $("#tradeDialogDescription").html(sprintf("Order <br/> %s SLS @ %s SLS/ETH <br/> Expires in %s blocks", sls, rate, rv.expires));
        $("#tradeDialogAmountLabel").text("SLS");
        $("#tradeDialogAmount").val(sls);
        $("#tradeDialogEth").val(eth);
        $("#tradeDialogFee").val(eth * feeRate);

        $("#tradeDialog").data("logId", logId);
        $("#tradeDialog").data("rate", rate);

        $("#tradeMask").show();
    }

    $(function() {
        $("#orderBook").on('click', "tr", function() {
            var logId = $(this).data("logid");
            if (logId) {
                openTradeDialog(logId);
            }
        });

        $("#myOrders").on('click', "tr", function() {
            var logId = $(this).data("logid");
            if (logId) {
                var e = eventList[logId];
                var rv = e.returnValues;

                var r = e.signature.slice(0, 34);
                var s = '0x' + e.signature.slice(34, 66);
                var v = '0x' + e.signature.slice(66, 68);
                v = web3.utils.toDecimal(v) + 27;

                solaExchange.methods.cancelOrder(rv.tokenGet, rv.amountGet, rv.tokenGive, rv.amountGive, rv.expires, rv.nonce, v, r, s).send({ from: account })
                    .then(function(r) {
                        console.log(r);
                        refreshOrder();
                    });
            }
        });

        $("#tradeDialogConfirm").click(function() {
            var logId = $("#tradeDialog").data("logId");
            var e = eventList[logId];
            var rv = e.returnValues;

            var r = e.signature.slice(0, 34);
            var s = '0x' + e.signature.slice(34, 66);
            var v = '0x' + e.signature.slice(66, 68);
            v = web3.utils.toDecimal(v) + 27;

            var amountGet;
            if (slsAddress == rv.tokenGet) {
                amountGet = slsToWei($("#tradeDialogAmount").val());
            } else {
                amountGet = web3.utils.toWei($("#tradeDialogEth").val(), 'ether');
            }

            solaExchange.methods.trade(rv.tokenGet, rv.amountGet, rv.tokenGive, rv.amountGive, rv.expires, rv.nonce, rv.user, v, r, s, amountGet).send({ from: account })
                .then(function(r) {
                    console.log(r);
                    refreshOrder();
                    refreshTrade();
                });

            $("#tradeMask").hide();
        });

        $("#tradeDialogAmount").bind('keyup mouseup', function() {
            var eth = $("#tradeDialog").data("rate") * $("#tradeDialogAmount").val();
            $("#tradeDialogEth").val(eth);
            $("#tradeDialogFee").val(eth * feeRate);
        });

        web3.eth.getAccounts().then(function(r) {
            account = r[0];
            $("#account").text(sprintf("Account: %s", account));
        });

        setInterval(function() {
            if (autoSwitchAccount) {
                web3.eth.getAccounts().then(function(r) {
                    if (account == r[0]) {
                        return;
                    }

                    account = r[0];
                    $("#account").text(sprintf("Account: %s", account));
                    dataInitialized = false;
                });
            }

            if (account) {
                web3.eth.getBlockNumber().then(function(r) {
                    currentBlock = r;
                    $("#currentBlock").text(sprintf("CurrentBlock: %s", currentBlock));

                    if (!dataInitialized) {
                        dataInitialized = true;
                        refreshOrder();
                        refreshTrade();
                        refreshTransfer();
                    } else {
                        refreshExpires();
                    }
                });

                web3.eth.getBalance(account).then(function(r) {
                    $("#ethInWallet").text(sprintf("ETH in wallet: %s", web3.utils.fromWei(r, 'ether')));
                });

                sls.methods.balanceOf(account).call().then(function(r) {
                    $("#slsInWallet").text(sprintf("SLS in wallet: %s", weiToSls(r)));
                });

                solaExchange.methods.balanceOf(ethAddress, account).call().then(function(r) {
                    $("#ethTokenInSolaExchange").text(sprintf("ETH Token in SolaExchange: %s", web3.utils.fromWei(r, 'ether')));
                });

                solaExchange.methods.balanceOf(slsAddress, account).call().then(function(r) {
                    $("#slsTokenInSolaExchange").text(sprintf("SLS Token in SolaExchange: %s", weiToSls(r)));
                });
            }
        }, 1000);
    });

    function btnDeposit() {
        var v = $("#ethToken").val();
        solaExchange.methods.deposit().send({ from: account, value: web3.utils.toWei(v, 'ether') })
            .then(console.log);
    }

    function btnWithdraw() {
        var v = $("#ethToken").val();
        solaExchange.methods.withdraw(web3.utils.toWei(v, 'ether')).send({ from: account })
            .then(console.log);
    }

    function slsToWei(v) {
        return v * 100000000;
    }

    function weiToSls(v) {
        return v / 100000000;
    }

    function btnApprove() {
        var v = $("#slsToken").val();
        sls.methods.approve(solaExchangeAddress, slsToWei(v)).send({ from: account })
            .then(console.log);
    }

    function btnDepositToken() {
        var v = $("#slsToken").val();
        solaExchange.methods.depositToken(slsAddress, slsToWei(v)).send({ from: account })
            .then(console.log);
    }

    function btnWithdrawToken() {
        var v = $("#slsToken").val();
        solaExchange.methods.withdrawToken(slsAddress, slsToWei(v)).send({ from: account })
            .then(console.log);
    }

    function btnOrderBuySls() {
        var get = $("#orderSlsToken").val();
        var give = $("#orderEthToken").val();
        var expires = parseInt($('#orderExpires').val()) + currentBlock;
        var nonce = Date.now();
        solaExchange.methods.order(slsAddress, slsToWei(get), ethAddress, web3.utils.toWei(give, 'ether'), expires, nonce).send({ from: account })
            .then(function(r) {
                console.log(r);
                refreshOrder();
            });
    }

    function btnOrderSellSls() {
        var get = $("#orderEthToken").val();
        var give = $("#orderSlsToken").val();
        var expires = parseInt($('#orderExpires').val()) + currentBlock;
        var nonce = Date.now();
        solaExchange.methods.order(ethAddress, web3.utils.toWei(get, 'ether'), slsAddress, slsToWei(give), expires, nonce).send({ from: account })
            .then(function(r) {
                console.log(r);
                refreshOrder();
            });
    }

    function refreshOrder() {
        solaExchange.getPastEvents('Order', {
                //filter: { myIndexedParam: [20, 23], myOtherIndexedParam: '0x123456789...' }, // Using an array means OR: e.g. 20 or 23
                fromBlock: 0,
                toBlock: 'latest'
            })
            .then(function(events) {
                orderBook = { count: 0, orders: {} };
                myOrders = { count: 0, orders: {} };

                for (var i = 0; i < events.length; ++i) {
                    var e = events[i];
                    var rv = e.returnValues;
                    //console.log(e);
                    var order, rate, sls, eth, remained;
                    if (slsAddress == rv.tokenGet) {
                        order = "BUY";
                        sls = weiToSls(rv.amountGet);
                        eth = web3.utils.fromWei(rv.amountGive, 'ether');
                        rate = eth / sls;
                        color = "lightgreen";
                    } else {
                        order = "SELL";
                        sls = weiToSls(rv.amountGive);
                        eth = web3.utils.fromWei(rv.amountGet, 'ether');
                        rate = eth / sls;
                        color = "red";
                    }

                    var expires = (rv.expires > currentBlock) ? rv.expires - currentBlock : 0;

                    if (expires > 0) {
                        orderBook.count += 1;
                        orderBook.orders[e.id] = { logId: e.id, order: order, sls: sls, eth: eth, rate: rate, color: color, nonce: rv.nonce, expires: expires };
                    }

                    if (rv.user == account) {
                        myOrders.count += 1;
                        myOrders.orders[e.id] = { logId: e.id, order: order, sls: sls, eth: eth, rate: rate, color: color, nonce: rv.nonce, expires: expires };
                    }

                    eventList[e.id] = e;
                    (function(event) {
                        solaExchange.methods.amountFilled(rv.tokenGet, rv.amountGet, rv.tokenGive, rv.amountGive, rv.expires, rv.nonce, rv.user, 0, "0x0", "0x0").call()
                            .then(function(filled) {
                                var need1 = updateOrderData(orderBook, event.id, filled);
                                var need2 = updateOrderData(myOrders, event.id, filled);
                                if (!(need1 || need2)) {
                                    delete eventList[event.id];
                                }

                                if (orderBook.count == 0) {
                                    var sortable = sortForOrderBook(orderBook.orders);

                                    $("#orderBook tr:gt(0)").remove();
                                    for (var s in sortable) {
                                        var o = sortable[s][0];
                                        $("#orderBook tr:last").after(sprintf("<tr id='o_%s' title='click to trade.' style='background: %s' data-logid='%s'><td>%s</td><td>%s</td><td>[%s/%s]</td><td>%s</td><td>%s</td></tr>", o.nonce, o.color, o.logId, o.order, o.rate, o.remained, o.sls, o.eth, o.expires));
                                    }
                                }

                                if (myOrders.count == 0) {
                                    $("#myOrders tr:gt(0)").remove();
                                    for (var id in myOrders.orders) {
                                        var o = myOrders.orders[id];
                                        $("#myOrders tr:last").after(sprintf("<tr id='mo_%s' title='click to cancel.' style='background: %s' data-logid='%s'><td>%s</td><td>%s</td><td>[%s/%s]</td><td>%s</td><td>%s</td><td>%s</td></tr>", o.nonce, (o.expires > 0 ? 'lightgrey' : 'dimgray'), o.logId, o.order, o.rate, o.remained, o.sls, o.eth, o.expires, (o.expires > 0 ? 'alive' : 'expired')));
                                    }
                                }
                            });
                    })(e);
                }
            });
    }

    function updateOrderData(orderData, eventId, filled) {
        if (orderData.orders[eventId]) {
            orderData.count -= 1;

            var o = orderData.orders[eventId];
            if (o.order == "BUY") {
                filled = weiToSls(filled);
                o.remained = o.sls - filled;
            } else {
                filled = web3.utils.fromWei(filled);
                o.remained = (o.eth - filled) * o.sls / o.eth;
            }

            if (o.remained == 0) {
                delete orderData.orders[eventId];
            } else {
                return true; //需要保留event log
            }
        }

        return false;
    }

    function sortForOrderBook(orders) {
        var sortable = [];
        for (var id in orders) {
            var o = orders[id];
            sortable.push([o, o.order, o.rate]);
        }

        sortable.sort(function(a, b) {
            if (a[1] != b[1]) {
                return (a[1] < b[1]) ? 1 : -1;
            } else {
                return b[2] - a[2];
            }
        });

        return sortable;
    }

    function refreshTrade() {
        solaExchange.getPastEvents('Trade', {
                //filter: { myIndexedParam: [20, 23], myOtherIndexedParam: '0x123456789...' }, // Using an array means OR: e.g. 20 or 23
                fromBlock: 0,
                toBlock: 'latest'
            })
            .then(function(trades) {
                $("#myTrades tr:gt(0)").remove();

                for (var i = 0; i < trades.length; i++) {
                    var rv = trades[i].returnValues;
                    if (rv.get == account || rv.give == account) {
                        var order, rate, sls, eth;
                        if (slsAddress == rv.tokenGet) {
                            order = (rv.get == account) ? "BUY" : "SELL";
                            sls = weiToSls(rv.amountGet);
                            eth = web3.utils.fromWei(rv.amountGive, 'ether');
                            rate = eth / sls;
                        } else {
                            order = (rv.give == account) ? "BUY" : "SELL";
                            sls = weiToSls(rv.amountGive);
                            eth = web3.utils.fromWei(rv.amountGet, 'ether');
                            rate = eth / sls;
                        }

                        $("#myTrades tr:last").after(sprintf("<tr style='background: lightgrey'><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>", order, rate, sls, eth));
                    }
                }
            });
    }

    function refreshExpires() {
        $("#orderBook tr").each(function() {
            var logId = $(this).data("logid");
            if (logId) {
                var e = eventList[logId];
                var rv = e.returnValues;
                var expires = (rv.expires > currentBlock) ? rv.expires - currentBlock : 0;

                $(this).find('td:last-child').text(expires);
                if (expires == 0) {
                    $(this).hide();
                }
            }
        });

        $("#myOrders tr").each(function() {
            var logId = $(this).data("logid");
            if (logId) {
                var e = eventList[logId];
                var rv = e.returnValues;
                var expires = (rv.expires > currentBlock) ? rv.expires - currentBlock : 0;

                $(this).find('td:nth-last-child(2)').text(expires);
                if (expires == 0) {
                    $(this).find('td:last-child').text("expired");
                    $(this).css("background", "dimgray");
                }
            }
        });
    }

    function btnTransfer() {
        var token = $("#transferToken").val();
        var amount = $("#transferTokenAmount").val();
        var address = $("#transferAddress").val();
        switch(token) {
            case "0":
                token = ethAddress;
                amount = web3.utils.toWei(amount, 'ether');
                break;
            case "1":
                token = slsAddress;
                amount = slsToWei(amount);
                break;
            default:
                alert("unknown token type");
                return;
        }
        solaExchange.methods.transferToken(token, amount, address).send({ from: account })
            .then(function(r) {
                console.log(r);
            });
    }

    function refreshTransfer() {
        solaExchange.getPastEvents('Transfer', {
                //filter: { myIndexedParam: [20, 23], myOtherIndexedParam: '0x123456789...' }, // Using an array means OR: e.g. 20 or 23
                fromBlock: 0,
                toBlock: 'latest'
            })
            .then(function(transfer) {
                console.log(transfer);
                $("#myTransferFrom tr:gt(0)").remove();
                $("#myTransferTo tr:gt(0)").remove();

                for (var i = 0; i < transfer.length; i++) {
                    var rv = transfer[i].returnValues;
                    var token, amount;
                    switch(rv.token) {
                        case ethAddress:
                            token = "ETH";
                            amount = web3.utils.fromWei(rv.amount, 'ether');
                            break;
                        case slsAddress:
                            token = "SLS";
                            amount = weiToSls(rv.amount);
                            break;
                        default:
                            alert("unknown token type");
                            return;
                    }

                    if (rv.receiver == account) {
                        $("#myTransferFrom tr:last").after(sprintf("<tr style='background: lightgrey'><td>%s</td><td>%s</td><td>%s</td></tr>", token, amount, "unknown"));
                    }
                    //TODO:myTransferTo
                }
            });
    }
    </script>
</head>

<body>
    <div id="account"></div>
    <div id="currentBlock"></div>
    <br/>
    <div id="ethInWallet"></div>
    <div id="slsInWallet"></div>
    <br/>
    <div id="ethTokenInSolaExchange"></div>
    <div id="slsTokenInSolaExchange"></div>
    <hr/>
    <input id="ethToken" type="number" value=0></input>
    <button type="button" onclick="btnDeposit()">deposit ETH</button>
    <button type="button" onclick="btnWithdraw()">withdraw ETH</button>
    <hr/>
    <input id="slsToken" type="number" value=0></input>
    <button type="button" onclick="btnApprove()">approve SLS</button>
    <button type="button" onclick="btnDepositToken()">depositToken SLS</button>
    <button type="button" onclick="btnWithdrawToken()">withdrawToken SLS</button>
    <hr/>
    <select id="transferToken">
        <option value="0">ETH</option>
        <option value="1">SLS</option>
    </select>
    <label>Amount:</label>
    <input id="transferTokenAmount" type="number" value=0></input>
    <label>Receiver Address:</label>
    <input id="transferAddress" type="text"></input>
    <button type="button" onclick="btnTransfer()">transfer</button>
    <hr/>
    <label>SLS:</label>
    <input id="orderSlsToken" type="number" value=0></input>
    <label>ETH:</label>
    <input id="orderEthToken" type="number" value=0></input>
    <label>Expires:</label>
    <input id="orderExpires" type="number" value=0></input>
    <button type="button" onclick="btnOrderBuySls()">order (buy SLS by paying ETH)</button>
    <button type="button" onclick="btnOrderSellSls()">order (sell SLS for obtaining ETH)</button>
    <hr/>
    <div>
        <span style="float: left">
            <label>Order Book</label>
            <table id="orderBook">
                <tr>
                    <th>Order</th>
                    <th>SLS/ETH</th>
                    <th>SLS</th>
                    <th>ETH</th>
                    <th>EXPIRES</th>
                </tr>
            </table>
        </span>
        <span style="float: left">
            <label>My Orders</label>
            <table id="myOrders">
                <tr>
                    <th>Order</th>
                    <th>SLS/ETH</th>
                    <th>SLS</th>
                    <th>ETH</th>
                    <th>EXPIRES</th>
                    <th>STATUS</th>
                </tr>
            </table>
        </span>
        <span style="float: left">
            <label>My Trades</label>
            <table id="myTrades">
                <tr>
                    <th>Trade</th>
                    <th>SLS/ETH</th>
                    <th>SLS</th>
                    <th>ETH</th>
                </tr>
            </table>
        </span>
        <span style="float: left">
            <label>My Transfer From</label>
            <table id="myTransferFrom">
                <tr>
                    <th>Token</th>
                    <th>Amount</th>
                    <th>Sender</th>
                </tr>
            </table>
        </span>

        <span style="float: left">
            <label>My Transfer To</label>
            <table id="myTransferTo">
                <tr>
                    <th>Token</th>
                    <th>Amount</th>
                    <th>Receiver</th>
                </tr>
            </table>
        </span>
    </div>
    <div id="tradeMask" hidden="true">
        <div id="tradeDialog">
            <label id="tradeDialogTradeType"></label>
            <hr/>
            <div id="tradeDialogDescription"></div>
            <br/>
            <div id="tradeDialogAmountLabel"></div>
            <input id="tradeDialogAmount" type="number"></input>
            <br/>
            <br/>
            <div>ETH</div>
            <input id="tradeDialogEth" type="number" disabled></input>
            <br/>
            <br/>
            <div>Fee (ETH)</div>
            <input id="tradeDialogFee" type="number" disabled></input>
            <br/>
            <br/>
            <hr/>
            <button id="tradeDialogCancel" type="button" onclick="$('#tradeMask').hide();">cancel</button>
            <button id="tradeDialogConfirm" type="button">trade</button>
        </div>
    </div>
</body>

</html>